@page "/draft-messages"
@attribute [Authorize]

<PageTitle>Draft Messages</PageTitle>

<h3 class="mb-4">Draft Messages</h3>

<Card HeaderTitle="Draft Messages">
    <Body>
        <SearchArea>
            <LeftRight>
                <Left>
                    <SearchBox @ref="searchBox" @onclick="ApplyFilter">
                    </SearchBox>
                </Left>
            </LeftRight>
        </SearchArea>
        <Table Items="filteredItems">
            <Columns>
                <Column Header="#"><input class="form-check-input" type="checkbox" /></Column>
                <Column Header="Sender">@context.SenderID</Column>
                <Column Header="Message">@context.MessageText</Column>
                <Column Header="Time">
                    <FormatDate DateTime="@context.SubmitDate"></FormatDate>
                </Column>
                <Column>
                    <Actions OnEdit="() => draftMessageModal.Show(context)"
                             OnDelete="() => draftMessageModal.Delete(context)">
                    </Actions>
                </Column>
            </Columns>
        </Table>
    </Body>
    <Footer>
        <Pager PageState="ds.PageState" OnPageChange="e => ds.SetPage(e).LoadData(alert)" />
    </Footer>
</Card>

<DraftMessageModal @ref="draftMessageModal"></DraftMessageModal>

@code {
    private SearchBox searchBox = new();
    private DraftMessageModal draftMessageModal = new();
    private ApiDataSource<SmsMessageResponse> ds = new();
    private List<SmsMessageResponse> filteredItems = new();
    private List<SmsMessageResponse> items = new();

    protected override async Task OnInitializedAsync()
    {
        ds.Callback = new(async (PageState p, FilterState? f) =>
        {
            var response = await apiClient.SmsMessageListAsync(p.PageNumber, p.PageSize, null, null);
            if (response.StatusCode == 200)
            {
                items = response.Result.ToList();
                ApplyFilter();
            }
            return response;
        });

        await ds.LoadData(alert);
    }

    private void ApplyFilter()
    {
        if (string.IsNullOrWhiteSpace(searchBox.Text))
        {
            filteredItems = items;
        }
        else
        {
            filteredItems = items
                .Where(i => i.MessageText.Contains(searchBox.Text, StringComparison.OrdinalIgnoreCase) ||
                            i.SenderID.Contains(searchBox.Text, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }
}
