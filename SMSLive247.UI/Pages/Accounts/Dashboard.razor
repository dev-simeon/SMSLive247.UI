@page "/Accounts/Dashboard"
@attribute [Authorize]

<PageTitle>Dashboard</PageTitle>

<h3 class="mb-3">Welcome, @accountDetail.LastName</h3>

<!-- Account Overview -->
<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted fw-medium">Wallet Balance</p>
                        <h4 class="mb-0">$ 6134.39</h4>
                    </div>
                    <div class="flex-shrink-0 align-self-center">
                        <div class="p-3 rounded-circle bg-primary">
                            <i class="fa fa-wallet h3 mb-0 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted fw-medium">SMS Credit Balance</p>
                        <h4 class="mb-0">@accountDetail.Credits</h4>
                    </div>
                    <div class="flex-shrink-0 align-self-center">
                        <div class="p-3 rounded-circle bg-primary">
                            <i class="bi bi-coin h3 mb-0 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted fw-medium">Total SMS Sent</p>
                        <h4 class="mb-0">@totalSmsSent</h4>
                    </div>
                    <div class="flex-shrink-0 align-self-center">
                        <div class="p-3 rounded-circle bg-primary">
                            <i class="bi bi-chat-dots h3 mb-0 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted fw-medium">Total Batch File</p>
                        <h4 class="mb-0">@batchFiles.Count</h4>
                    </div>
                    <div class="flex-shrink-0 align-self-center">
                        <div class="p-3 rounded-circle bg-primary">
                            <i class="bi bi-file-earmark-arrow-down h3 mb-0 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <Card HeaderTitle="Traffic Summary">
            <Body>
                <div id="trafficSummaryChart"></div>
            </Body>
        </Card>
    </div>
    <div class="col-md-6">
        <Card HeaderTitle="Recent Transactions">
            <Body>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var transaction in recentTransactions)
                        {
                            <tr>
                                <td><FormatDate DateTime="@transaction.DateCreated"></FormatDate></td>
                                <td>@transaction.Reference</td>
                                <td>@transaction.Amount</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </Body>
        </Card>
    </div>
</div>

<!-- Support and Help -->
<div class="row mt-4">
    <div class="col-md-6">
        <Card HeaderTitle="Contact Support">
            <Body>
                <a href="/support">Live Chat or Email Support</a>
            </Body>
        </Card>
    </div>
</div>

@code {
    private AccountResponse accountDetail = new();
    private List<SmsBatchResponse> recentMessages =[];
    private List<ContactResponse> contacts = [];
    private List<GroupResponse> groups = [];
    private List<PurchaseResponse> recentTransactions = [];
    private List<BatchFileResponse> batchFiles = [];
    private int totalSmsSent = 0;
    private double deliveryRates = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var t1 = apiClient.AccountGetAsync("self");
            var t2 = apiClient.SmsBatchListAsync(1, 500, DateTimeOffset.UtcNow.Date.AddDays(-7), DateTimeOffset.UtcNow.Date, null);
            var t3 = apiClient.ContactListAsync();
            var t4 = apiClient.GroupListAsync();
            var t5 = apiClient.PurchaseListAsync(1, 500);
            var t6 = apiClient.BatchFileListAsync();


            await Task.WhenAll(t1, t2, t3, t4, t5, t6);

            accountDetail = t1.Result.Result;
            recentMessages = t2.Result.Result.ToList();
            contacts = t3.Result.Result.ToList();
            groups = t4.Result.Result.ToList();
            recentTransactions = t5.Result.Result.ToList();
            batchFiles = t6.Result.Result.ToList();

            totalSmsSent = (int)recentMessages.Sum(m => m.TotalProcessed);
            deliveryRates = CalculateDeliveryRates(recentMessages);

            await RenderTrafficSummaryChart();
        }
        catch (Exception ex)
        {
            await alert.Error(ex.Message, "Error");
        }
    }

    private double CalculateDeliveryRates(List<SmsBatchResponse> messages)
    {
        // Implement logic to calculate delivery rates
        return 0;
    }

    private async Task RenderTrafficSummaryChart()
    {
        var seriesData = recentMessages.Select(m => m.TotalProcessed + m.TotalFailed).ToArray();
        var categories = recentMessages.Select(m => m.DateSubmitted.ToString("dd MMM")).ToArray();

        var options = new
        {
            chart = new
            {
                type = "bar"
            },
            plotOptions = new
            {
                bar = new
                {
                    colors = new
                    {
                        ranges = new[]
                        {
                        new { from = 0, to = 1000, color = "#F15B46" },
                        new { from = 1001, to = 5000, color = "#FEB019" },
                        new { from = 5001, to = 10000, color = "#00E396" }
                    },
                        backgroundBarColors = new[] { "#F0F0F0" },
                        backgroundBarOpacity = 1,
                    }
                }
            },
            colors = new[] { "#FF4560" }, // Default color for bars
            series = new[]
            {
            new { name = "Messages Sent", data = seriesData }
        },
            xaxis = new
            {
                categories
            }
        };

        await js.InvokeVoidAsync("apexChartsInterop.renderChart", "trafficSummaryChart", options);
    }

}
